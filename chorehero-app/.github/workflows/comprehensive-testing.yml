# ============================================================================
# CHOREHERO COMPREHENSIVE AUTOMATED TESTING CI/CD PIPELINE
# Bulletproof testing that prevents ANY regression of the 28 fixed gaps
# ============================================================================

name: ğŸ›¡ï¸ ChoreHero Bulletproof Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run comprehensive tests every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'full_suite'
        type: choice
        options:
        - full_suite
        - regression_only
        - journey_only
        - quick_check

env:
  NODE_VERSION: '18'
  EXPO_VERSION: '49'

jobs:
  # ============================================================================
  # SETUP & PREPARATION
  # ============================================================================
  
  setup:
    name: ğŸ”§ Setup Testing Environment
    runs-on: ubuntu-latest
    outputs:
      test-type: ${{ steps.determine-test-type.outputs.test-type }}
      should-run-full: ${{ steps.determine-test-type.outputs.should-run-full }}
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ¯ Determine Test Type
      id: determine-test-type
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "test-type=${{ github.event.inputs.test_type }}" >> $GITHUB_OUTPUT
          echo "should-run-full=true" >> $GITHUB_OUTPUT
        elif [[ "${{ github.event_name }}" == "schedule" ]]; then
          echo "test-type=full_suite" >> $GITHUB_OUTPUT
          echo "should-run-full=true" >> $GITHUB_OUTPUT
        elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "test-type=regression_only" >> $GITHUB_OUTPUT
          echo "should-run-full=false" >> $GITHUB_OUTPUT
        else
          echo "test-type=quick_check" >> $GITHUB_OUTPUT
          echo "should-run-full=false" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ“Š Test Configuration Summary
      run: |
        echo "ğŸ¯ Test Type: ${{ steps.determine-test-type.outputs.test-type }}"
        echo "ğŸš€ Full Suite: ${{ steps.determine-test-type.outputs.should-run-full }}"
        echo "ğŸ“… Trigger: ${{ github.event_name }}"

  # ============================================================================
  # GAP REGRESSION TESTS - CRITICAL PRIORITY
  # ============================================================================
  
  gap-regression-tests:
    name: ğŸ” Gap Regression Tests (All 28 Gaps)
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        cd chorehero-app
        npm ci
    
    - name: ğŸ”§ Setup Test Environment
      run: |
        cd chorehero-app
        echo "EXPO_PUBLIC_SUPABASE_URL=${{ secrets.SUPABASE_TEST_URL }}" >> .env.test
        echo "EXPO_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_TEST_ANON_KEY }}" >> .env.test
        echo "STRIPE_TEST_SECRET_KEY=${{ secrets.STRIPE_TEST_SECRET_KEY }}" >> .env.test
    
    - name: ğŸ§ª Run Gap Regression Test Suite
      run: |
        cd chorehero-app
        npm run test:gap-regression
      env:
        NODE_ENV: test
        CI: true
    
    - name: ğŸ“Š Upload Gap Regression Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: gap-regression-results
        path: chorehero-app/test-results/gap-regression-*.json
        retention-days: 30
    
    - name: ğŸ’¬ Comment Gap Regression Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          try {
            const results = JSON.parse(fs.readFileSync('chorehero-app/test-results/gap-regression-latest.json', 'utf8'));
            const comment = `
            ## ğŸ” Gap Regression Test Results
            
            **Status**: ${results.passedTests === results.totalTests ? 'âœ… ALL GAPS REMAIN FIXED' : 'âŒ REGRESSION DETECTED'}
            **Tests**: ${results.passedTests}/${results.totalTests} passed
            **Coverage**: ${results.coverage.toFixed(1)}%
            **Execution Time**: ${results.executionTime}ms
            
            ${results.failedTests > 0 ? `
            ### âš ï¸ CRITICAL: Gap Regressions Detected
            
            ${results.results.filter(r => r.status === 'failed').map(r => 
              `- **Gap #${r.gapNumber}**: ${r.testName} - ${r.error}`
            ).join('\n')}
            
            **ğŸš¨ These gaps were previously fixed and must not regress!**
            ` : '### ğŸ‰ All 28 fixed gaps remain bulletproof!'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('Could not read test results:', error);
          }

  # ============================================================================
  # USER JOURNEY TESTS
  # ============================================================================
  
  user-journey-tests:
    name: ğŸƒ User Journey Tests
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should-run-full == 'true' || github.event.inputs.test_type == 'journey_only'
    
    strategy:
      matrix:
        journey: ['customer', 'cleaner', 'cross-role']
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        cd chorehero-app
        npm ci
    
    - name: ğŸ”§ Setup Test Environment
      run: |
        cd chorehero-app
        echo "EXPO_PUBLIC_SUPABASE_URL=${{ secrets.SUPABASE_TEST_URL }}" >> .env.test
        echo "EXPO_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_TEST_ANON_KEY }}" >> .env.test
    
    - name: ğŸƒ Run ${{ matrix.journey }} Journey Test
      run: |
        cd chorehero-app
        npm run test:journey:${{ matrix.journey }}
      env:
        NODE_ENV: test
        CI: true
    
    - name: ğŸ“Š Upload Journey Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: journey-results-${{ matrix.journey }}
        path: chorehero-app/test-results/journey-${{ matrix.journey }}-*.json
        retention-days: 30

  # ============================================================================
  # PERFORMANCE & STRESS TESTS
  # ============================================================================
  
  performance-tests:
    name: âš¡ Performance & Stress Tests
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should-run-full == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        cd chorehero-app
        npm ci
        npm install -g artillery clinic
    
    - name: âš¡ Run Performance Tests
      run: |
        cd chorehero-app
        npm run test:performance
      env:
        NODE_ENV: test
        CI: true
    
    - name: ğŸ”¥ Run Stress Tests
      run: |
        cd chorehero-app
        npm run test:stress
      env:
        NODE_ENV: test
        CI: true
    
    - name: ğŸ“Š Upload Performance Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-results
        path: chorehero-app/test-results/performance-*.json
        retention-days: 30

  # ============================================================================
  # SECURITY & VULNERABILITY TESTS
  # ============================================================================
  
  security-tests:
    name: ğŸ”’ Security & Vulnerability Tests
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should-run-full == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        cd chorehero-app
        npm ci
    
    - name: ğŸ” Run Security Audit
      run: |
        cd chorehero-app
        npm audit --audit-level=moderate
    
    - name: ğŸ”’ Run Authorization Tests
      run: |
        cd chorehero-app
        npm run test:security
      env:
        NODE_ENV: test
        CI: true
    
    - name: ğŸ“Š Upload Security Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-results
        path: chorehero-app/test-results/security-*.json
        retention-days: 30

  # ============================================================================
  # COMPREHENSIVE REPORT GENERATION
  # ============================================================================
  
  generate-comprehensive-report:
    name: ğŸ“Š Generate Comprehensive Test Report
    runs-on: ubuntu-latest
    needs: [setup, gap-regression-tests, user-journey-tests, performance-tests, security-tests]
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Download All Test Results
      uses: actions/download-artifact@v4
      with:
        path: test-artifacts
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ“Š Generate Comprehensive Report
      run: |
        cd chorehero-app
        npm ci
        npm run test:report:generate
      env:
        TEST_ARTIFACTS_PATH: ../test-artifacts
    
    - name: ğŸ“‹ Create Summary Report
      run: |
        cd chorehero-app
        node scripts/create-test-summary.js
    
    - name: ğŸ“Š Upload Comprehensive Report
      uses: actions/upload-artifact@v4
      with:
        name: comprehensive-test-report
        path: chorehero-app/test-results/comprehensive-report-*.html
        retention-days: 90
    
    - name: ğŸ’¬ Post Comprehensive Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          try {
            const summary = JSON.parse(fs.readFileSync('chorehero-app/test-results/test-summary.json', 'utf8'));
            
            const statusEmoji = summary.overallHealth === 'excellent' ? 'ğŸŸ¢' : 
                               summary.overallHealth === 'good' ? 'ğŸŸ¡' : 
                               summary.overallHealth === 'warning' ? 'ğŸŸ ' : 'ğŸ”´';
            
            const comment = `
            ## ğŸ›¡ï¸ ChoreHero Bulletproof Testing Results
            
            ### ${statusEmoji} Overall Health: ${summary.overallHealth.toUpperCase()} (${summary.healthScore}/100)
            
            | Test Category | Status | Details |
            |---------------|--------|---------|
            | ğŸ” Gap Regression | ${summary.gapRegression.status} | ${summary.gapRegression.passed}/${summary.gapRegression.total} gaps protected |
            | ğŸ‘¤ Customer Journey | ${summary.customerJourney.status} | ${summary.customerJourney.stepsCompleted}/${summary.customerJourney.totalSteps} steps |
            | ğŸ§¹ Cleaner Journey | ${summary.cleanerJourney.status} | ${summary.cleanerJourney.stepsCompleted}/${summary.cleanerJourney.totalSteps} steps |
            | ğŸ¤ Cross-Role Interaction | ${summary.crossRole.status} | ${summary.crossRole.syncPoints} sync points |
            | âš¡ Performance | ${summary.performance.status} | ${summary.performance.avgResponseTime}ms avg |
            | ğŸ”’ Security | ${summary.security.status} | ${summary.security.vulnerabilities} vulnerabilities |
            
            ### ğŸ“Š Test Execution Summary
            - **Total Tests**: ${summary.totalTests}
            - **Execution Time**: ${summary.totalExecutionTime}ms
            - **Coverage**: ${summary.coverage}%
            
            ${summary.healthScore < 85 ? `
            ### âš ï¸ Action Required
            ${summary.criticalIssues.map(issue => `- ${issue}`).join('\n')}
            ` : '### âœ… All Systems Bulletproof!'}
            
            ğŸ“‹ [View Detailed Report](${summary.reportUrl})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('Could not read test summary:', error);
          }

  # ============================================================================
  # DEPLOYMENT GATE
  # ============================================================================
  
  deployment-gate:
    name: ğŸš¦ Deployment Gate
    runs-on: ubuntu-latest
    needs: [gap-regression-tests, user-journey-tests, performance-tests, security-tests]
    if: always()
    
    steps:
    - name: ğŸ“Š Evaluate Test Results
      id: evaluate
      run: |
        # Check if all critical tests passed
        GAP_RESULT="${{ needs.gap-regression-tests.result }}"
        JOURNEY_RESULT="${{ needs.user-journey-tests.result }}"
        PERF_RESULT="${{ needs.performance-tests.result }}"
        SECURITY_RESULT="${{ needs.security-tests.result }}"
        
        echo "Gap Regression: $GAP_RESULT"
        echo "User Journeys: $JOURNEY_RESULT"
        echo "Performance: $PERF_RESULT"
        echo "Security: $SECURITY_RESULT"
        
        # Gap regression tests MUST pass
        if [[ "$GAP_RESULT" != "success" ]]; then
          echo "deployment-approved=false" >> $GITHUB_OUTPUT
          echo "reason=Gap regression tests failed - critical system gaps detected" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Count failures
        FAILURES=0
        [[ "$JOURNEY_RESULT" != "success" ]] && FAILURES=$((FAILURES + 1))
        [[ "$PERF_RESULT" != "success" ]] && FAILURES=$((FAILURES + 1))
        [[ "$SECURITY_RESULT" != "success" ]] && FAILURES=$((FAILURES + 1))
        
        if [[ $FAILURES -eq 0 ]]; then
          echo "deployment-approved=true" >> $GITHUB_OUTPUT
          echo "reason=All tests passed - deployment approved" >> $GITHUB_OUTPUT
        elif [[ $FAILURES -le 1 ]]; then
          echo "deployment-approved=true" >> $GITHUB_OUTPUT
          echo "reason=Minor issues detected but deployment approved with monitoring" >> $GITHUB_OUTPUT
        else
          echo "deployment-approved=false" >> $GITHUB_OUTPUT
          echo "reason=Multiple test failures - deployment blocked" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: ğŸš¦ Deployment Decision
      run: |
        echo "### ğŸš¦ Deployment Gate Decision"
        echo "**Approved**: ${{ steps.evaluate.outputs.deployment-approved }}"
        echo "**Reason**: ${{ steps.evaluate.outputs.reason }}"
        
        if [[ "${{ steps.evaluate.outputs.deployment-approved }}" == "true" ]]; then
          echo "âœ… Deployment APPROVED - ChoreHero remains bulletproof!"
        else
          echo "âŒ Deployment BLOCKED - System integrity at risk!"
          exit 1
        fi

  # ============================================================================
  # NOTIFICATION & ALERTS
  # ============================================================================
  
  notify-results:
    name: ğŸ“¢ Notify Test Results
    runs-on: ubuntu-latest
    needs: [deployment-gate]
    if: always()
    
    steps:
    - name: ğŸ“¢ Success Notification
      if: needs.deployment-gate.result == 'success'
      run: |
        echo "ğŸ‰ ChoreHero Testing Pipeline Completed Successfully!"
        echo "âœ… All 28 gaps remain fixed"
        echo "âœ… System integrity verified"
        echo "âœ… Deployment approved"
        
        # In production, send success notifications to:
        # - Slack/Discord
        # - Team email
        # - Dashboard updates
    
    - name: ğŸš¨ Failure Notification
      if: needs.deployment-gate.result == 'failure'
      run: |
        echo "ğŸš¨ CRITICAL: ChoreHero Testing Pipeline Failed!"
        echo "âŒ System integrity compromised"
        echo "âŒ Deployment blocked"
        echo "ğŸ”§ Immediate action required"
        
        # In production, send critical alerts to:
        # - PagerDuty/incident management
        # - SMS alerts to on-call engineers  
        # - Slack with @here mentions
        # - Email to engineering leadership
