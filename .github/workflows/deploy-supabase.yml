name: Deploy Supabase Functions

# Required GitHub secrets (Settings → Secrets and variables → Actions):
#   SUPABASE_ACCESS_TOKEN - from https://supabase.com/dashboard/account/tokens
#   SUPABASE_PROJECT_REF  - project ID from dashboard URL (e.g. kluwipcdwaaeqxjmbcti)

on:
  push:
    branches:
      - main
    paths:
      - 'chorehero-app/supabase/functions/**'
      - '.github/workflows/deploy-supabase.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: 1.97.0

      - name: Validate secrets
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "::error::SUPABASE_ACCESS_TOKEN secret is not set. Add it at Settings → Secrets → Actions"
            exit 1
          fi
          if [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "::error::SUPABASE_PROJECT_REF secret is not set. Add it at Settings → Secrets → Actions"
            exit 1
          fi
          echo "Secrets validated"

      - name: Deploy supabase functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          cd chorehero-app
          supabase functions deploy create-payment-intent --project-ref $SUPABASE_PROJECT_REF
          supabase functions deploy stripe-webhook --project-ref $SUPABASE_PROJECT_REF --no-verify-jwt
